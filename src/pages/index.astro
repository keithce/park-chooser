---
import { pickPark, getConvexUrl } from "../lib/convexClient";
import Analytics from "@vercel/analytics/astro";
import "../styles/global.css";

let park = null;
let error = null;

try {
  park = await pickPark();
} catch (e) {
  error = e instanceof Error ? e.message : "Failed to pick a park";
  console.error("Error picking park:", e);
}

const convexUrl = getConvexUrl();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Today's Park</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <Analytics />
  </head>
  <body>
    <div class="container">
      <header>
        <h1 class="title">Today's Park</h1>
        <p class="subtitle">A random adventure awaits</p>
      </header>

      <main id="park-display">
        {
          error ? (
            <div class="error-card">
              <div class="error-icon">⚠️</div>
              <p class="error-message">{error}</p>
              <p class="error-hint">
                Make sure Convex is running and parks are synced.
              </p>
            </div>
          ) : park ? (
            <article class="park-card">
              {park.photoUrl && (
                <div class="park-image-wrapper">
                  <img
                    src={park.photoUrl}
                    alt={`Photo of ${park.name}`}
                    class="park-image"
                    loading="eager"
                  />
                  <div class="image-overlay" />
                </div>
              )}
              <div class="park-info">
                {park.customName && (
                  <p class="park-custom-name">{park.customName}</p>
                )}
                <h2 class="park-name">{park.name}</h2>
                {park.address && <p class="park-address">{park.address}</p>}
                <a
                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(park.name)}&query_place_id=${park.placeId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="maps-link"
                  data-park-id={park._id}
                >
                  Open in Google Maps →
                </a>
              </div>
            </article>
          ) : (
            <div class="loading-card">
              <div class="spinner" />
              <p>Finding your park...</p>
            </div>
          )
        }
      </main>

      <div class="actions">
        <button id="pick-again" class="pick-button" disabled={!park && !error}>
          <span class="button-text">Pick Another Park</span>
          <span class="button-spinner hidden"></span>
        </button>
      </div>

      <footer>
        <p>Parks are chosen randomly, with no repeats in the last 5 picks.</p>
        <p><a href="/stats" class="stats-link">View run stats →</a></p>
      </footer>
    </div>

    <script define:vars={{ convexUrl }}>
      const button = document.getElementById("pick-again");
      const display = document.getElementById("park-display");

      async function pickNewPark() {
        button.disabled = true;
        button.querySelector(".button-text").textContent = "Finding park...";
        button.querySelector(".button-spinner").classList.remove("hidden");

        try {
          const response = await fetch(`${convexUrl}/api/action`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "actions/pickPark:pickPark",
              args: {},
              format: "json",
            }),
          });

          const result = await response.json();

          if (result.status === "error") {
            throw new Error(result.errorMessage || "Failed to pick park");
          }

          const park = result.value;

          display.innerHTML = `
            <article class="park-card">
              ${
                park.photoUrl
                  ? `
                <div class="park-image-wrapper">
                  <img
                    src="${park.photoUrl}"
                    alt="Photo of ${park.name}"
                    class="park-image"
                    loading="eager"
                  />
                  <div class="image-overlay"></div>
                </div>
              `
                  : ""
              }
              <div class="park-info">
                ${park.customName ? `<p class="park-custom-name">${park.customName}</p>` : ""}
                <h2 class="park-name">${park.name}</h2>
                ${park.address ? `<p class="park-address">${park.address}</p>` : ""}
                <a
                  href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(park.name)}&query_place_id=${park.placeId}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="maps-link"
                  data-park-id="${park._id}"
                >
                  Open in Google Maps →
                </a>
              </div>
            </article>
          `;
        } catch (err) {
          display.innerHTML = `
            <div class="error-card">
              <div class="error-icon">⚠️</div>
              <p class="error-message">${err.message}</p>
            </div>
          `;
        } finally {
          button.disabled = false;
          button.querySelector(".button-text").textContent =
            "Pick Another Park";
          button.querySelector(".button-spinner").classList.add("hidden");
        }
      }

      // Track visits when clicking "Open in Google Maps"
      // Uses fetch with keepalive for reliable fire-and-forget tracking that survives navigation
      function trackVisit(parkId) {
        fetch(`${convexUrl}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            path: "actions/trackVisit:trackVisit",
            args: { parkId },
            format: "json",
          }),
          keepalive: true, // Ensures request completes even if page unloads
        }).catch(() => {}); // Silently ignore errors for fire-and-forget
      }

      // Attach click handlers to maps links
      function attachMapsLinkHandlers() {
        document.querySelectorAll(".maps-link").forEach((link) => {
          link.addEventListener("click", () => {
            const parkId = link.dataset.parkId;
            if (parkId) {
              trackVisit(parkId);
            }
          });
        });
      }

      // Attach handlers on initial load
      attachMapsLinkHandlers();

      // Re-attach after picking a new park
      const originalPickNewPark = pickNewPark;
      pickNewPark = async function () {
        await originalPickNewPark();
        attachMapsLinkHandlers();
      };

      button.addEventListener("click", pickNewPark);
    </script>
  </body>
</html>
